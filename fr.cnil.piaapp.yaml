app-id: fr.cnil.piaapp
base: org.electronjs.Electron2.BaseApp
base-version: '20.08'
runtime: org.freedesktop.Platform
runtime-version: '20.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.node10
command: /app/bin/run.sh
finish-args:
  - --socket=x11
  - --share=ipc
  - --device=dri         # Without DRI the app doesn't come up :-/
  #- --filesystem=home
  #- --share=network
  #- --talk-name=org.freedesktop.Notifications
        
modules:
  # Copied from https://github.com/flatpak/flatpak-builder-tools/blob/ca5863a21454e81b04218f22cea83b2f78abed0b/node/vanilla-quick-start/org.electronjs.ElectronQuickStart.yaml#L31
  - name: node
    buildsystem: simple
    build-commands:
      - '/usr/lib/sdk/node10/install-sdk.sh'

  - name: yarn
    buildsystem: simple
    build-commands:
      - 'cp -a * /app'
    # Only used for building, so clean it up afterwards.
    cleanup:
      - '*'
    sources:
      - type: archive
        url: https://github.com/yarnpkg/yarn/releases/download/v1.19.1/yarn-v1.19.1.tar.gz
        sha256: 34293da6266f2aae9690d59c2d764056053ff7eebc56b80b8df05010c3da9343

  - name: pia-app
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/node10/bin
      env:
        NPM_CONFIG_LOGLEVEL: info
        npm_config_nodedir: /usr/lib/sdk/node10

        # Tell caches where we pre-downloaded things.
        npm_config_cache: /run/build/pia-app/flatpak-node/npm-cache/
        electron_config_cache: /run/build/pia-app/flatpak-node/electron-cache

        # Tell the chromedriver npm package where we pre-downloaded things.
        ELECTRON_CACHE: /run/build/pia-app/flatpak-node/electron-cache
    build-commands:
      - node --version
      - npm --version
      - yarn --version
      - env TMPDIR=$FLATPAK_BUILDER_BUILDDIR/flatpak-node/tmp HOME=$PWD yarn config --offline set yarn-offline-mirror $FLATPAK_BUILDER_BUILDDIR/flatpak-node/yarn-mirror
      - yarn --offline
      - yarn --offline --verbose run electron-builder --linux --dir

      - mkdir -p /app/pia
      - cp -ar releases/linux-unpacked/* /app/pia/

      # Install the required static files
      - install run.sh /app/bin/run.sh
      - install -Dm 0644 fr.cnil.piaapp.desktop  /app/share/applications/fr.cnil.piaapp.desktop
      - install -Dm 0644 static/fr.cnil.piaapp.appdata.xml  /app/share/metainfo/fr.cnil.piaapp.appdata.xml
      - install -Dm 0644 fr.cnil.piaapp.png /app/share/icons/hicolor/512x512/apps/fr.cnil.piaapp.png

    sources:
      # The chromedriver package tries to download a bunch of files
      # outside of the normal npm dependencies.  Pre-download them and
      # use ELECTRON_CACHE to point to them.
      # Taken from https://github.com/electron/chromedriver/issues/28#issuecomment-42783936
      - type: file
        only-arches: ["x86_64"]
        url: https://github.com/electron/electron/releases/download/v4.0.0/chromedriver-v4.0.0-linux-x64.zip
        sha256: 221db18ea2f3a8267f9a57ee61a9d5a6df09824c61bf8cefa360502cae503d7c
        dest: flatpak-node/electron-cache

      - type: file
        url: https://github.com/electron/electron/releases/download/v4.0.0/SHASUMS256.txt
        sha256: 52dfb903bf248db3b2c94cdcddd310034cd743098c13b5b10c71272ad6f812d1
        dest-filename: SHASUMS256.txt-4.0.0
        dest: flatpak-node/electron-cache

      - type: archive
        url: https://github.com/LINCnil/pia-app/archive/v2.3.0.tar.gz
        sha256: f643f03c3e86799952945cae586a2d5613a2927dea2ac663b44ba7bc01168a26

      - type: file
        url: https://github.com/LINCnil/pia-app/raw/97ac75d1aa6ff0e61a046b845e297c5703dd4db2/icons/512x512.png
        sha256: ebb71f7254f2c862d2277a527ed18746591305088086040b98e5fc9bc43a1529
        dest-filename: fr.cnil.piaapp.png

      - type: file
        path: fr.cnil.piaapp.desktop

      - type: script
        dest-filename: run.sh
        commands:
          - export TMPDIR="$XDG_RUNTIME_DIR/app/$FLATPAK_ID"
          - exec zypak-wrapper /app/pia/pia "$@"


      - generated-sources.0.json


      - type: file
        dest: static
        path: fr.cnil.piaapp.appdata.xml

      - type: patch
        path: 0001-disabled-updater.patch
